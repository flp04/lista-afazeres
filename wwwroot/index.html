<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <title>Lista de Afazeres</title>
  <style>
    body {
      background-color: black;
      color: white;
    }
    h3 {
      font-weight: bold;
      color: black;
      padding: 5px;
    }
    input {
      border: none;
      border-radius: 3px;
    }
    .input-data {
      width: 220px;
      height: 36px;
      font-size: 24px;
      text-align: center;
      margin-top: 7px;
      font-weight: bold;
    }
    #quadro {
      border: 2px black solid;
      border-radius: 10px;
      min-height: 500px;
    }
    .hoje {
      background-color: darksalmon;
    }
    .amanha {
      background-color: deepskyblue;
    }
    .outro {
      background-color: gold;
    }
    .afazer {
      border: 1px gainsboro solid;
      border-radius: 5px;
      margin: 10px;
      background-color: gainsboro;
    }
  </style>
</head>
<body>
  <section id="app">
    <h1 style="text-align: center; padding: 15px;">LISTA DE AFAZERES</h2>
    <label style="margin: 5px;" for=""><input style="margin: 5px;" type="checkbox" onchange="ocultarConcluidos(this)">Ocultar concluídos</label>

    <div class="row" style="margin: 5px;">
      <div id="quadro" class="col-md-4 hoje">
        <h3 style="text-align: center;" id="hoje">Hoje</h3>
        <div id="lista-hoje" class="lista">
          <div id="afazer1" class="afazer">
            <input style="width: 80%; margin: 5px" type="text" placeholder="Digite um afazer" oninput="observadorInput(this)" onblur="salvarInput(this)" onkeydown="if(event.key === 'Enter')moverCursor(this)">
            <svg onclick="marcarFeito(this)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black" class="bi bi-check2" viewBox="0 0 16 16">
              <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
            </svg>
            <svg onclick="editar(this)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black" class="bi bi-pencil-fill" viewBox="0 0 16 16">
              <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z"/>
            </svg>
            <svg onclick="excluir(this)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black" class="bi bi-trash3-fill" viewBox="0 0 16 16">
              <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5m-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5M4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528M8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5"/>
            </svg>
            <!-- <span style="cursor: pointer;" onclick="excluir(this)">X</span> -->
          </div>
        </div>
      </div>
      <div id="quadro" class="col-md-4 amanha">
        <h3 style="text-align: center;" id="amanha">Amanhã</h3>
        <div id="lista-amanha" class="lista">
          <div id="afazer1" class="afazer">
            <input style="width: 80%; margin: 5px" type="text" placeholder="Digite um afazer" oninput="observadorInput(this)" onblur="salvarInput(this)" onkeydown="if(event.key === 'Enter')moverCursor(this)">
            <svg onclick="marcarFeito(this)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black" class="bi bi-check2" viewBox="0 0 16 16">
              <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
            </svg>
            <svg onclick="editar(this)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black" class="bi bi-pencil-fill" viewBox="0 0 16 16">
              <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z"/>
            </svg>
            <svg onclick="excluir(this)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black" class="bi bi-trash3-fill" viewBox="0 0 16 16">
              <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5m-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5M4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528M8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5"/>
            </svg>
            <!-- <span style="cursor: pointer;" onclick="excluir(this)">X</span> -->
          </div>
        </div>
      </div>
      <div id="quadro" class="col-md-4 outro" style="text-align: center;">
        <input type="date" id="input-outro-dia" class="input-data" onchange="atualizarData(this)" value="2024-09-15">
        <!-- <h3 style="text-align: center;" id="amanha">Outro</h3> -->
        <div id="lista-outro-dia" class="lista">
          <div id="afazer1" class="afazer">
            <input style="width: 80%; margin: 5px" type="text" placeholder="Digite um afazer" oninput="observadorInput(this)" onblur="salvarInput(this)" onkeydown="if(event.key === 'Enter')moverCursor(this)">
            <svg onclick="marcarFeito(this)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black" class="bi bi-check2" viewBox="0 0 16 16">
              <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
            </svg>
            <svg onclick="editar(this)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black" class="bi bi-pencil-fill" viewBox="0 0 16 16">
              <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z"/>
            </svg>
            <svg onclick="excluir(this)" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black" class="bi bi-trash3-fill" viewBox="0 0 16 16">
              <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5m-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5M4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06m6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528M8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5"/>
            </svg>
            <!-- <span style="cursor: pointer;" onclick="excluir(this)">X</span> -->
          </div>
        </div>
      </div>
    </div>
  </section>
  <script>
    let depois_amanha = () => { 
      let depois_amanha = new Date()
      depois_amanha.setDate(depois_amanha.getDate() + 2)
      depois_amanha = (`${depois_amanha.getFullYear()}-${(depois_amanha.getMonth()+1).toString().padStart(2, '0')}-${depois_amanha.getDate()}`)
      document.getElementById('input-outro-dia').value = depois_amanha
      return depois_amanha
    }

    let dataFormatada = (quando) => {
      let data = 0
      if (quando == 'hoje') {
        data = new Date()
      } else if (quando == 'amanha') {
        data = new Date()
        data.setDate(data.getDate() + 1)
        // return amanha
      } else {
        data = 'não definida'
      }
      const dia = String(data.getDate()).padStart(2, '0'); // dia com dois dígitos
      const mes = String(data.getMonth() + 1).padStart(2, '0'); // mês com dois dígitos (os meses são indexados a partir de 0)
      const ano = data.getFullYear(); // ano completo
      return `${dia}/${mes}/${ano}`;
    }
        
    getLista("hoje")
    getLista("amanha")
    getLista(depois_amanha())

    document.getElementById('hoje').textContent += ' - ' + dataFormatada('hoje')
    document.getElementById('amanha').textContent += ' - ' + dataFormatada('amanha')

    function observadorInput (event) {
      let divAfazerAtual = event.parentNode
      let ultimoAfazerLista = divAfazerAtual.parentNode.children[divAfazerAtual.parentNode.children.length-1]
      if (divAfazerAtual == ultimoAfazerLista) {
        let nova_div_afazer = divAfazerAtual.cloneNode(true)
        nova_div_afazer.children[0].value = '' // limpa o valor do input
        nova_div_afazer.id = `afazer${parseInt(divAfazerAtual.id.replace('afazer', '')) + 1}`
        divAfazerAtual.parentNode.appendChild(nova_div_afazer)
      }
    }

    function getLista (quando) {
      fetch(`https://localhost:7116/Lista/${quando}`, {
        method: 'GET', // Método HTTP
        headers: {
          'Content-Type': 'application/json' // Especifica que estamos enviando JSON
        },
      })
      .then(response => {
        if (!response.ok) {
          // Trata erros de resposta (HTTP 4xx ou 5xx)
          throw new Error('Erro na requisição: ' + response.status);
        }
        return response.json(); // Converte a resposta em JSON
      })
      .then(data => {
        quando = ['hoje', 'amanha'].includes(quando) ? quando : 'outro-dia'
        let lista = document.getElementById(`lista-${quando}`)
        if (data.length > 0) {
          data.forEach((afazer, i) => {
            if (i == 0) {
              lista.children[i].children[0].disabled = true
              lista.children[i].children[0].value = afazer.descricao
              lista.children[i].children[0].setAttribute('idbd', afazer.id)
              if (afazer.status) {
                riscaTarefaExcluiBotoes(lista.children[i])
              } else {
                reexibeBotoes(lista.children[i])
              }
            } else {
              let novoElemento = lista.children[lista.children.length-1].cloneNode(true)
              novoElemento.id = `afazer${i + 1}`
              novoElemento.children[0].value = afazer.descricao
              novoElemento.children[0].setAttribute('idbd', afazer.id)
              if (afazer.status) {
                riscaTarefaExcluiBotoes(novoElemento)
              } else {
                reexibeBotoes(novoElemento)
              }
              lista.appendChild(novoElemento)
            }
          })
          let novoElementoVazio = lista.children[lista.children.length-1].cloneNode(true)
          novoElementoVazio.id = `afazer${(lista.children.length) + 1}`
          novoElementoVazio.children[0].value = ''
          novoElementoVazio.children[0].disabled = false
          reexibeBotoes(novoElementoVazio)
          lista.appendChild(novoElementoVazio)
        }
      })
      .catch(error => {
        console.error('Erro:', error); // Trata erros na requisição
      });
    }

    function salvarInput (event) {
      if (event.value != '') {
        let afazer = {
          descricao: event.value,
          status: false,
        }
        
        let quando = event.parentNode.parentNode.id.replace("lista-", "")
        if (!['hoje', 'amanha'].includes(quando)) {
          quando = document.getElementById('input-outro-dia').value
        }

        fetch(`https://localhost:7116/Afazer/${quando}`, {
        method: 'POST', // Método HTTP
        headers: {
            'Content-Type': 'application/json' // Especifica que estamos enviando JSON
          },
          body: JSON.stringify(afazer) // Converte o objeto JavaScript em uma string JSON
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Erro na requisição: ' + response.status);
          }
          return response.json(); // Converte a resposta em JSON
        })
        .then(data => {
          event.disabled = true
          event.setAttribute('idbd', data.id)
        })
        .catch(error => {
          console.error('Erro:', error); // Trata erros na requisição
        });
      }
    }

    function excluir (event) {
      let divAfazerAtual = event.parentNode
      let listaAtual = event.parentNode.parentNode.children 

      if (listaAtual.length > 1 && listaAtual[listaAtual.length-1] != divAfazerAtual && divAfazerAtual.children[0].value != '') {
        fetch(`https://localhost:7116/Afazer/${divAfazerAtual.children[0].getAttribute('idbd')}`, {
          method: 'DELETE', // Método HTTP
          headers: {
            'Content-Type': 'application/json' // Especifica que estamos enviando JSON
          },
        })
        .then(response => {
          if (!response.ok) {
            // Trata erros de resposta (HTTP 4xx ou 5xx)
            throw new Error('Erro na requisição: ' + response.status);
          }
          return response.json(); // Converte a resposta em JSON
        })
        .then(data => {
          divAfazerAtual.remove()
        })
      }
    }
    function editar (event) {
      event.parentNode.children[0].disabled = false
      event.parentNode.children[0].focus()
      event.parentNode.children[0].setAttribute('onblur', 'atualizar(this)')
      event.parentNode.children[0].setAttribute('onkeydown', "if(event.key === 'Enter')moverCursor(this)")
    }
    function atualizar(event) {
      fetch(`https://localhost:7116/Afazer/${event.getAttribute('idbd')}`, {
        method: 'PUT', // Método HTTP
        headers: {
          'Content-Type': 'application/json'},
           // Especifica que estamos enviando JSON
          body: JSON.stringify(event.value) // Converte o objeto JavaScript em uma string JSON
      })
      .then(response => {
        if (!response.ok) {
          // Trata erros de resposta (HTTP 4xx ou 5xx)
          throw new Error('Erro na requisição: ' + response.status);
        }
        return response.json(); // Converte a resposta em JSON
      })
      .then(data => {
        event.disabled = true
      })
    }

    function marcarFeito (event) {
      if (event.parentNode.children[0].value != '') {
        fetch(`https://localhost:7116/Afazer/ConcluirAfazer/${event.parentNode.children[0].getAttribute('idbd')}`, {
          method: 'PUT', // Método HTTP
          headers: {
            'Content-Type': 'application/json'},
             // Especifica que estamos enviando JSON
            // body: JSON.stringify(event.value) // Converte o objeto JavaScript em uma string JSON
        })
        .then(response => {
          if (!response.ok) {
            // Trata erros de resposta (HTTP 4xx ou 5xx)
            throw new Error('Erro na requisição: ' + response.status);
          }
          return response.json(); // Converte a resposta em JSON
        })
        .then(data => {
          riscaTarefaExcluiBotoes(event.parentNode)
        })
      }
    }
    function atualizarData (event) {

      // console.log(event.parentNode.children[1])
      // console.log(event.parentNode.children[1].children.length)
      // console.log(event.parentNode.children[1].children.length)
      
      // let novoElementoVazio = event.parentNode.children[1].children[event.parentNode.children[1].children.length-1].cloneNode(true)
      // novoElementoVazio.id = `afazer${(event.parentNode.children[1].children.length) + 1}`
      // novoElementoVazio.children[0].value = ''
      // novoElementoVazio.children[0].disabled = false
      // reexibeBotoes(novoElementoVazio)

      // let novaLista = event.parentNode.children[1].cloneNode()
      // console.log(novaLista)
      // event.parentNode.children[1].remove()
      if (event.parentNode.children[1].children.length > 1) {
        while (event.parentNode.children[1].children.length > 1) {
          event.parentNode.children[1].children[0].remove()
        }
      }
      // event.parentNode.children[1] = novaLista
      // novaLista.appendChild(novoElementoVazio)
      
      getLista(event.value)
    }
    function ocultarConcluidos(event) {
      let listas = document.getElementsByClassName('lista')
      for (let i = 0; i < listas.length; i++) {
        for (let j = 0; j < listas[i].children.length; j++) {
          if (window.getComputedStyle(listas[i].children[j].children[0]).textDecoration.includes('line-through')) {
            if (event.checked) {
              listas[i].children[j].style.display = 'none'
            } else {
              listas[i].children[j].style.display = 'block'
            }
          }
        } 
      }
    }
    function moverCursor (event) {
      event.parentNode.parentNode.querySelector(`#afazer${parseInt(event.parentNode.parentNode.children.length)}`).children[0].focus()
    }
    function riscaTarefaExcluiBotoes (elemento) {
      elemento.children[0].style.textDecoration = 'line-through'
      elemento.children[0].style.width = '97%'
      elemento.children[3].style.display = 'none'
      elemento.children[2].style.display = 'none'
      elemento.children[1].style.display = 'none'
    }
    
    function reexibeBotoes (elemento) {
      elemento.children[0].style.textDecoration = 'none'
      elemento.children[0].style.width = '80%'
      elemento.children[1].style.display = 'inline-block'
      elemento.children[2].style.display = 'inline-block'
      elemento.children[3].style.display = 'inline-block'
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>